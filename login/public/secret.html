<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secret Page</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .secret { padding: 20px; }
    .hint { font-size: 14px; color: #6b7280; margin-bottom: 12px; }
    .center { text-align:center }
    .small { font-size:13px;color:#6b7280 }
  </style>
</head>
<body>
  <main class="container">
    <div class="card secret" id="root">
      <h1 id="title">Protected Content</h1>
      <div id="locked">
        <p class="hint">Enter the password to view the protected content.</p>
        <form id="unlockForm">
          <div class="field">
            <label for="unlockPassword">Password</label>
            <input id="unlockPassword" type="password" required />
            <div class="error" id="unlockError" aria-live="polite"></div>
          </div>
          <button type="submit">Unlock</button>
        </form>
        <p class="small">Hint: demo password is <code>password123</code></p>
      </div>

      <div id="content" style="display:none">
        <h2>Welcome, <span id="userNameDisplay">user</span>! ðŸŽ‰</h2>
        <p class="hint">Below is your dashboard with live weather and top crypto prices.</p>
        <div id="react-root"></div>
        <div class="center" style="margin-top:16px">
          <button id="logoutBtn">Logout</button>
        </div>
      </div>

    </div>
  </main>

  <script>
  const unlockForm = document.getElementById('unlockForm');
  const unlockError = document.getElementById('unlockError');
    const locked = document.getElementById('locked');
    const content = document.getElementById('content');
    const logoutBtn = document.getElementById('logoutBtn');

    function showContent() {
      locked.style.display = 'none';
      content.style.display = 'block';
      document.getElementById('title').textContent = 'Secret Area';
    }

    function isAuthenticated() {
      // sessionStorage set on (successful) login; fallback also sets token in localStorage
      return sessionStorage.getItem('auth') === 'true' || !!localStorage.getItem('token');
    }

    if (isAuthenticated()) {
      // If already authenticated, show content and display username
      const name = sessionStorage.getItem('username') || '';
      const display = document.getElementById('userNameDisplay');
      if (display) display.textContent = name || 'user';
      showContent();
    } else {
      // Not authenticated: replace unlock form with clear instructions
      const lockedEl = document.getElementById('locked');
      if (lockedEl) {
        lockedEl.innerHTML = `
          <p class="hint">You must sign in to view this page.</p>
          <p class="small">Please <a href="index.html">Sign in</a> or <a href="register.html">Create an account</a>.</p>
        `;
      }
    }

    logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('auth');
      sessionStorage.removeItem('username');
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    });
    
    // Simple vanilla-JS dashboard to avoid CDN/Babel load issues.
    let dashboardMounted = false;
    function mountDashboard() {
      if (dashboardMounted) return;
      dashboardMounted = true;
      const root = document.getElementById('react-root');
      if (!root) return;
      root.innerHTML = `
        <div style="padding:12px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div id="weatherCard" style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(12,38,75,0.08)">
              <h3>ðŸŒ¦ Weather</h3>
              <p id="weatherStatus">Loading...</p>
            </div>
            <div id="cryptoCard" style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(12,38,75,0.08)">
              <h3>ðŸ’° Top Cryptos</h3>
              <ul id="cryptoList"><li>Loading...</li></ul>
            </div>
          </div>
        </div>
      `;

      // Fetch weather
      fetch('https://api.open-meteo.com/v1/forecast?latitude=51.5072&longitude=-0.1276&current_weather=true')
        .then(res => res.json())
        .then(data => {
          const w = data && data.current_weather;
          const status = document.getElementById('weatherStatus');
          if (w && typeof w.temperature !== 'undefined') {
            // Open-Meteo returns temperature in Celsius
            status.textContent = `${w.temperature}Â°C, Wind ${w.windspeed} km/h`;
          } else {
            status.textContent = 'Weather data not available';
            console.warn('Unexpected weather response', data);
          }
        })
        .catch(err => {
          const status = document.getElementById('weatherStatus');
          status.textContent = 'Failed to load weather';
          console.warn('Weather fetch failed', err);
        });

      // Fetch crypto data
      fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=5')
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('cryptoList');
          list.innerHTML = '';
          if (Array.isArray(data) && data.length) {
            data.forEach(c => {
              const li = document.createElement('li');
              li.textContent = `${c.name}: $${c.current_price}`;
              list.appendChild(li);
            });
          } else {
            list.innerHTML = '<li>No crypto data</li>';
            console.warn('Unexpected crypto response', data);
          }
        })
        .catch(err => {
          const list = document.getElementById('cryptoList');
          list.innerHTML = '<li>Failed to load crypto data</li>';
          console.warn('Crypto fetch failed', err);
        });
    }

    // When showing content, mount the dashboard
    const originalShow = showContent;
    showContent = function() {
      originalShow();
      mountDashboard();
    };
  </script>
</body>
</html>